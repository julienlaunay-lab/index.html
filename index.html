<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Configurateur – location masses d’essai</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --muted:#5b6475;
      --text:#0f172a;
      --line:rgba(2,6,23,.12);
      --accent:#2563eb;
      --good:#16a34a;
      --warn:#f59e0b;
      --soft:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#ffffff, #f8fafc 60%, #ffffff);
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    h1{margin:0 0 6px;font-size:28px;letter-spacing:-.02em}
    p.sub{margin:0 0 18px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns:1fr 1fr;gap:16px}}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:0 10px 30px rgba(2,6,23,.06);
    }
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:520px){.row.two{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input,select{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--line);
      background:#fff; color:var(--text); outline:none;
    }
    input:focus,select:focus{border-color:rgba(37,99,235,.5); box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    input::placeholder{color:rgba(15,23,42,.35)}
    .pill{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{
      flex:1;min-width:190px;background:var(--soft);
      border:1px solid var(--line);border-radius:16px;padding:12px
    }
    .kpi .t{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:18px;font-weight:750;margin-top:4px}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .table{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff}
    .thead,.trow{display:grid;grid-template-columns: 6fr 2fr 2fr 2fr;gap:10px;align-items:center}
    .thead{background:#f8fafc;padding:10px 12px;font-size:12px;color:var(--muted)}
    .trow{padding:10px 12px;border-top:1px solid var(--line);font-size:14px}
    .thead.stock,.trow.stock{grid-template-columns: 5fr 2fr 2fr 2fr 1fr}
    .right{text-align:right}
    .note{font-size:12px;color:var(--muted)}
    .warn{border:1px solid rgba(245,158,11,.35);background:rgba(245,158,11,.10);border-radius:16px;padding:10px 12px}
    .good{border:1px solid rgba(22,163,74,.35);background:rgba(22,163,74,.10);border-radius:16px;padding:10px 12px}
    .btns{display:flex;gap:10px;flex-wrap:wrap}
    button{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:#fff; color:var(--text); cursor:pointer
    }
    button:hover{border-color:rgba(2,6,23,.25)}
    .big{font-size:22px;font-weight:850}
    .muted{color:var(--muted)}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      border:1px solid var(--line); background:#fff; border-radius:999px;
      padding:6px 10px; font-size:12px; color:var(--muted)
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Configurateur – location masses d’essai</h1>
    <p class="sub">Saisis la masse (kg), les dates, le département et le type de camion. Le tarif + transport + préparation + stock dispo se calculent automatiquement.</p>

    <div class="grid">
      <!-- Paramètres -->
      <div class="card">
        <div class="row two">
          <div>
            <label for="masseKg">Masse totale demandée (kg)</label>
            <input id="masseKg" inputmode="decimal" placeholder="Ex : 12000" />
          </div>
          <div>
            <label for="typeCamion">Type de camion</label>
            <select id="typeCamion">
              <option value="6M">6M</option>
              <option value="9M">9M</option>
              <option value="Complet" selected>Complet</option>
            </select>
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label for="dateDebut">Date début (calendrier)</label>
            <input id="dateDebut" type="date" />
          </div>
          <div>
            <label for="dateFin">Date fin (calendrier)</label>
            <input id="dateFin" type="date" />
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div>
            <label for="departement">Département de livraison</label>
            <select id="departement"></select>
          </div>
          <div>
            <label for="tarifKgJour">Tarif location (€/kg/jour)</label>
            <input id="tarifKgJour" type="number" step="0.001" min="0" />
          </div>
        </div>

        <div class="pill">
          <div class="kpi">
            <div class="t">Durée (jours ouvrés)</div>
            <div class="v" id="kpiDuree">—</div>
            <div class="note">(Lun→Ven, inclusif, min 1)</div>
          </div>
          <div class="kpi">
            <div class="t">Minimum location</div>
            <div class="v">250,00 €</div>
            <div class="note">forfait mini</div>
          </div>
          <div class="kpi">
            <div class="t">Transport</div>
            <div class="v"><span class="badge">Aller simple (grille) ×2 A/R</span></div>
            <div class="note">Tarif GO compris</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="btns">
          <button id="resetBtn" type="button">Réinitialiser</button>
        </div>

        <div class="note" style="margin-top:10px">
          Stock : calculé sur la période sélectionnée en déduisant les réservations déjà enregistrées (voir la liste dans le code).
        </div>
      </div>

      <!-- Résultat -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-end;flex-wrap:wrap">
          <div>
            <div class="muted" style="font-size:12px">Total offre (HT)</div>
            <div class="big" id="kpiTotal">—</div>
          </div>
          <div class="muted" id="resume" style="font-size:12px;max-width:560px;text-align:right"></div>
        </div>

        <div class="sep"></div>

        <div id="alerts"></div>

        <div style="margin-top:12px">
          <div style="font-weight:750;margin-bottom:8px">Stock dispo sur la période</div>
          <div class="table">
            <div class="thead stock">
              <div>Type</div>
              <div class="right">Stock</div>
              <div class="right">Réservé</div>
              <div class="right">Dispo</div>
              <div class="right">OK</div>
            </div>
            <div id="stockRows"></div>
          </div>
          <div class="note" style="margin-top:8px">
            “Réservé” = total des réservations qui chevauchent tes dates (même 1 jour).
          </div>
        </div>

        <div class="sep"></div>

        <div style="margin-top:12px">
          <div style="font-weight:750;margin-bottom:8px">Préparation (décomposition automatique)</div>
          <div class="table" id="prepTable">
            <div class="thead">
              <div>Type de masse</div>
              <div class="right">Qté</div>
              <div class="right">Unitaire</div>
              <div class="right">Total</div>
            </div>
            <div id="prepRows"></div>
            <div class="trow" style="background:#f8fafc">
              <div class="muted" style="grid-column:1 / span 3">Total préparé</div>
              <div class="right" style="font-weight:850" id="prepTotal">—</div>
            </div>
          </div>
          <div id="prepMsg" style="margin-top:10px"></div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div class="kpi">
            <div class="t">Location (brut)</div>
            <div class="v" id="locBrut">—</div>
          </div>
          <div class="kpi">
            <div class="t">Location (min 250€ appliqué)</div>
            <div class="v" id="locMin">—</div>
          </div>
        </div>

        <div class="row two" style="margin-top:10px">
          <div class="kpi">
            <div class="t">Transport (aller simple)</div>
            <div class="v" id="trAller">—</div>
          </div>
          <div class="kpi">
            <div class="t">Transport (aller/retour)</div>
            <div class="v" id="trAR">—</div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  // ======= PARAMÈTRES =======
  const MIN_LOCATION = 250;

  // Stock (issu de ton XLS) : poids unitaires (kg) + quantité totale
  const MASSES = [
    { ref: "orange", poidsKg: 2500, dispo: 8 },
    { ref: "jaune", poidsKg: 2000, dispo: 1 },
    { ref: "vert", poidsKg: 1000, dispo: 4 },
    { ref: "rouge/marron", poidsKg: 500, dispo: 9 },
    { ref: "bleu", poidsKg: 200, dispo: 3 },
    { ref: "noir", poidsKg: 25, dispo: 26 },
    { ref: "châssis (chaîne incluse)", poidsKg: 2500, dispo: 1 },
    { ref: "petit timon", poidsKg: 56, dispo: 1 },
    { ref: "grand timon", poidsKg: 200, dispo: 1 },
  ];

  // Transport (aller simple). Aller/retour = x2. Colonnes = type de camion.
  const TARIFS = {
    "14": { "6M": 425, "9M": 495, "Complet": 525 },
    "17": { "6M": 413, "9M": 480, "Complet": 512 },
    "18": { "6M": 515, "9M": 600, "Complet": 656 },
    "22": { "6M": 425, "9M": 485, "Complet": 512 },
    "27": { "6M": 585, "9M": 620, "Complet": 695 },
    "28": { "6M": 475, "9M": 500, "Complet": 523 },
    "29": { "6M": 564, "9M": 612, "Complet": 650 },
    "35": { "6M": 315, "9M": 370, "Complet": 400 },
    "36": { "6M": 545, "9M": 612, "Complet": 645 },
    "37": { "6M": 465, "9M": 490, "Complet": 511 },
    "41": { "6M": 585, "9M": 612, "Complet": 623 },
    "44": { "6M": 285, "9M": 315, "Complet": 335 },
    "45": { "6M": 642, "9M": 685, "Complet": 702 },
    "49": { "6M": 315, "9M": 355, "Complet": 395 },
    "50 Nord": { "6M": 735, "9M": 785, "Complet": 812 },
    "50 Sud": { "6M": 475, "9M": 495, "Complet": 511 },
    "56": { "6M": 425, "9M": 485, "Complet": 512 },
    "61": { "6M": 545, "9M": 595, "Complet": 610 },
    "72": { "6M": 435, "9M": 495, "Complet": 513 },
    "76": { "6M": 645, "9M": 685, "Complet": 735 },
    "79": { "6M": 435, "9M": 465, "Complet": 495 },
    "85": { "6M": 385, "9M": 401, "Complet": 425 },
  };

  // >>> IMPORTANT <<<
  // Réservations déjà prises (à maintenir / compléter).
  // Format : dates ISO yyyy-mm-dd + quantités par type (ref).
  // Toute réservation qui CHEVAUCHE ta période est comptée comme "réservée".
  const RESERVATIONS = [
    // Exemple :
    // {
    //   id: "LOC-2025-001",
    //   start: "2025-03-03",
    //   end:   "2025-03-07",
    //   items: { "orange": 2, "noir": 10, "bleu": 1 }
    // },
  ];

  // ======= HELPERS =======
  const EUR = (n) => (n==null || Number.isNaN(n)) ? "—" :
    new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n);

  const NF = (n) => (n==null || Number.isNaN(n)) ? "—" :
    new Intl.NumberFormat("fr-FR",{maximumFractionDigits:0}).format(n);

  const NF2 = (n) => (n==null || Number.isNaN(n)) ? "—" :
    new Intl.NumberFormat("fr-FR",{maximumFractionDigits:2}).format(n);

  function parseDateISO(s){
    // input type=date => yyyy-mm-dd
    if(!s) return null;
    const [y,m,d] = s.split("-").map(x => parseInt(x,10));
    if(!y||!m||!d) return null;
    return new Date(Date.UTC(y,m-1,d));
  }

  function overlaps(aStart, aEnd, bStart, bEnd){
    // chevauchement inclusif
    return !(aEnd < bStart || aStart > bEnd);
  }

  function businessDaysInclusive(startIso, endIso){
    const s = parseDateISO(startIso);
    const e = parseDateISO(endIso);
    if(!s || !e) return null;
    if(e < s) return null;

    // compte Lun..Ven inclusif
    let count = 0;
    const d = new Date(s.getTime());
    while(d <= e){
      const dow = d.getUTCDay(); // 0=Dim, 6=Sam
      if(dow !== 0 && dow !== 6) count++;
      d.setUTCDate(d.getUTCDate() + 1);
    }
    return Math.max(1, count); // min 1 jour
  }

  function getReservedMap(startIso, endIso){
    const s = parseDateISO(startIso);
    const e = parseDateISO(endIso);
    const reserved = Object.create(null);

    if(!s || !e || e < s) return reserved;

    for(const r of RESERVATIONS){
      const rs = parseDateISO(r.start);
      const re = parseDateISO(r.end);
      if(!rs || !re) continue;
      if(!overlaps(s, e, rs, re)) continue;

      for(const [ref, qty] of Object.entries(r.items || {})){
        reserved[ref] = (reserved[ref] || 0) + (Number(qty) || 0);
      }
    }
    return reserved;
  }

  function getAvailableMasses(startIso, endIso){
    const reserved = getReservedMap(startIso, endIso);
    return MASSES
      .map(m => {
        const res = reserved[m.ref] || 0;
        const dispo = Math.max(0, (m.dispo || 0) - res);
        return { ...m, reserved: res, dispoRestante: dispo };
      })
      .sort((a,b)=> b.poidsKg - a.poidsKg);
  }

  function computeDecomposition(masseDemandeeKg, massesDisponibles){
    if(masseDemandeeKg == null) return { lignes:[], totalKg:0, ok:false };

    let reste = Math.max(0, Math.round(masseDemandeeKg));
    const lignes = [];

    // Greedy du plus lourd au plus léger (avec dispoRestante)
    for(const m of massesDisponibles){
      if(reste <= 0) break;
      const dispo = m.dispoRestante ?? m.dispo ?? 0;
      if(dispo <= 0) continue;

      const qte = Math.min(dispo, Math.floor(reste / m.poidsKg));
      if(qte > 0){
        const sousTotal = qte * m.poidsKg;
        lignes.push({ ref:m.ref, poidsKg:m.poidsKg, qte, sousTotalKg:sousTotal });
        reste -= sousTotal;
      }
    }

    // Complète avec les plus petites (si reliquat)
    if(reste > 0){
      const asc = [...massesDisponibles].sort((a,b)=>a.poidsKg - b.poidsKg);
      for(const m of asc){
        if(reste <= 0) break;

        const dispoTotal = m.dispoRestante ?? m.dispo ?? 0;
        const deja = lignes.find(x=>x.ref === m.ref);
        const dejaQte = deja ? deja.qte : 0;
        const dispoRestante = Math.max(0, dispoTotal - dejaQte);
        if(dispoRestante <= 0) continue;

        const qteAjout = Math.min(dispoRestante, Math.ceil(reste / m.poidsKg));
        if(qteAjout > 0){
          if(deja){
            deja.qte += qteAjout;
            deja.sousTotalKg += qteAjout * m.poidsKg;
          } else {
            lignes.push({ ref:m.ref, poidsKg:m.poidsKg, qte:qteAjout, sousTotalKg:qteAjout*m.poidsKg });
          }
          reste -= qteAjout * m.poidsKg;
        }
      }
    }

    const lignesTriees = lignes.filter(l=>l.qte>0).sort((a,b)=>b.poidsKg - a.poidsKg);
    const totalKg = lignesTriees.reduce((s,l)=>s+l.sousTotalKg,0);
    return { lignes:lignesTriees, totalKg, ok: totalKg >= Math.round(masseDemandeeKg) };
  }

  // ======= UI =======
  const els = {
    masseKg: document.getElementById("masseKg"),
    dateDebut: document.getElementById("dateDebut"),
    dateFin: document.getElementById("dateFin"),
    departement: document.getElementById("departement"),
    typeCamion: document.getElementById("typeCamion"),
    tarifKgJour: document.getElementById("tarifKgJour"),
    resetBtn: document.getElementById("resetBtn"),

    kpiDuree: document.getElementById("kpiDuree"),
    kpiTotal: document.getElementById("kpiTotal"),
    resume: document.getElementById("resume"),

    alerts: document.getElementById("alerts"),
    prepRows: document.getElementById("prepRows"),
    prepTotal: document.getElementById("prepTotal"),
    prepMsg: document.getElementById("prepMsg"),

    stockRows: document.getElementById("stockRows"),

    locBrut: document.getElementById("locBrut"),
    locMin: document.getElementById("locMin"),
    trAller: document.getElementById("trAller"),
    trAR: document.getElementById("trAR"),
  };

  // Defaults
  els.tarifKgJour.value = "0.05";

  // Populate départements
  (function initDepartements(){
    const keys = Object.keys(TARIFS);
    els.departement.innerHTML = `<option value="">— Choisir —</option>` + keys.map(k => `<option value="${k}">${k}</option>`).join("");
  })();

  function getMasseKgNum(){
    const v = String(els.masseKg.value ?? "").trim().replace(",", ".");
    if(!v) return null;
    const n = Number(v);
    return Number.isFinite(n) && n >= 0 ? n : null;
  }

  function getTarifNum(){
    const v = String(els.tarifKgJour.value ?? "").trim().replace(",", ".");
    if(!v) return null;
    const n = Number(v);
    return Number.isFinite(n) && n >= 0 ? n : null;
  }

  function render(){
    const masse = getMasseKgNum();
    const tarif = getTarifNum();
    const d1 = els.dateDebut.value;
    const d2 = els.dateFin.value;
    const dep = els.departement.value;
    const typeCamion = els.typeCamion.value;

    const jours = businessDaysInclusive(d1, d2);

    // Alerts
    const alerts = [];
    if(d1 && d2){
      const s = parseDateISO(d1), e = parseDateISO(d2);
      if(s && e && e < s) alerts.push({kind:"warn", text:"La date de fin est avant la date de début."});
    }
    if(els.masseKg.value && masse == null) alerts.push({kind:"warn", text:"La masse doit être un nombre positif (en kg)."});
    if(els.tarifKgJour.value && tarif == null) alerts.push({kind:"warn", text:"Le tarif doit être un nombre positif."});
    if(dep && !TARIFS[dep]) alerts.push({kind:"warn", text:"Département non trouvé dans la grille transport."});

    els.alerts.innerHTML = alerts.map(a =>
      `<div class="${a.kind === "warn" ? "warn" : "good"}" style="margin-bottom:8px">${a.text}</div>`
    ).join("");

    // Durée ouvrée
    els.kpiDuree.textContent = (jours==null) ? "—" : `${jours} j`;

    // Transport
    const trAller = (!dep || !TARIFS[dep]) ? null : (TARIFS[dep][typeCamion] ?? null);
    const trAR = (trAller==null) ? null : trAller * 2;

    // Location
    const locBrut = (masse==null || jours==null || tarif==null) ? null : masse * tarif * jours;
    const locMin = (locBrut==null) ? null : Math.max(MIN_LOCATION, locBrut);

    // Total
    const total = (locMin==null || trAR==null) ? null : locMin + trAR;

    els.locBrut.textContent = EUR(locBrut);
    els.locMin.textContent  = EUR(locMin);
    els.trAller.textContent = EUR(trAller);
    els.trAR.textContent    = EUR(trAR);
    els.kpiTotal.textContent= EUR(total);

    // Résumé
    if(total==null){
      els.resume.textContent = "Renseigne masse, dates et département pour obtenir un total.";
    } else {
      els.resume.textContent = `Pour ${NF(masse)} kg sur ${jours} jour(s) ouvré(s) en ${dep} (${typeCamion}) · Tarif ${NF2(tarif)} €/kg/j`;
    }

    // Stock sur période (déduit réservations)
    const massesDisponibles = getAvailableMasses(d1, d2);
    els.stockRows.innerHTML = massesDisponibles.map(m => {
      const ok = m.dispoRestante > 0;
      return `
        <div class="trow stock">
          <div>${m.ref}</div>
          <div class="right">${NF(m.dispo)}</div>
          <div class="right">${NF(m.reserved)}</div>
          <div class="right" style="font-weight:750">${NF(m.dispoRestante)}</div>
          <div class="right" style="font-weight:850;color:${ok ? "var(--good)" : "var(--warn)"}">${ok ? "OK" : "0"}</div>
        </div>
      `;
    }).join("");

    // Décomposition (utilise le stock restant)
    const plan = (masse==null) ? { lignes:[], totalKg:0, ok:false } : computeDecomposition(masse, massesDisponibles);

    els.prepRows.innerHTML = plan.lignes.length === 0
      ? `<div class="trow"><div class="muted" style="grid-column:1 / span 4">—</div></div>`
      : plan.lignes.map(l => `
          <div class="trow">
            <div>${l.ref}</div>
            <div class="right" style="font-weight:750">${NF(l.qte)}</div>
            <div class="right" style="color:rgba(15,23,42,.70)">${NF(l.poidsKg)} kg</div>
            <div class="right" style="font-weight:750">${NF(l.sousTotalKg)} kg</div>
          </div>
        `).join("");

    els.prepTotal.textContent = (masse==null) ? "—" : `${NF(plan.totalKg)} kg`;

    els.prepMsg.innerHTML = "";
    if(masse != null){
      const delta = plan.totalKg - Math.round(masse);
      els.prepMsg.innerHTML = plan.ok
        ? `<div class="good">Objectif atteint. Surplus : ${NF(delta)} kg (stock restant pris en compte).</div>`
        : `<div class="warn"><b>Attention :</b> stock insuffisant sur ces dates pour atteindre ${NF(masse)} kg (réservations déjà déduites).</div>`;
    }
  }

  ["input","change"].forEach(evt=>{
    els.masseKg.addEventListener(evt,render);
    els.tarifKgJour.addEventListener(evt,render);
    els.dateDebut.addEventListener(evt,render);
    els.dateFin.addEventListener(evt,render);
    els.departement.addEventListener(evt,render);
    els.typeCamion.addEventListener(evt,render);
  });

  els.resetBtn.addEventListener("click", () => {
    els.masseKg.value = "";
    els.dateDebut.value = "";
    els.dateFin.value = "";
    els.departement.value = "";
    els.typeCamion.value = "Complet";
    els.tarifKgJour.value = "0.05";
    render();
  });

  render();
</script>
</body>
</html>

</body>
</html>
